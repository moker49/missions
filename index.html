<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Dice Throne Tracker</title>
		<link
			href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@1"
			rel="stylesheet"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Roboto&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="styles.css" />
	</head>
	<body>
		<div id="perkTab" class="tab-content active">
			<div class="scroll-container">
				<div class="perk-list" id="perkGrid"></div>
			</div>
		</div>

		<div id="missionTab" class="tab-content">
			<div class="scroll-container">
				<div class="mission-list" id="missionGrid"></div>
			</div>
		</div>

		<script>
			const perkGrid = document.getElementById("perkGrid");
			const missionGrid = document.getElementById("missionGrid");

			// DOM Creation
			function createDiv(className, textContent = "") {
				const el = document.createElement("div");
				el.className = className;
				el.textContent = textContent;
				return el;
			}

			// PERKS
			const perks = [
				[
					{ label: "Momentum Lvl 1", icons: ["looks_one"], perkPoints: 0 },
					{ label: "HP +1", icons: ["heart_plus"], perkPoints: 1 },
					{ label: "Focus Fire", icons: ["target"], perkPoints: 3 },
					{ label: "Momentum +1", icons: ["add_box"], perkPoints: 2 },
					{ label: "Re-roll enemy die", icons: ["cycle"], perkPoints: 3 },
				],
				[
					{ label: "Momentum Lvl 2", icons: ["looks_two"], perkPoints: 3 },
					{ label: "HP +2", icons: ["heart_plus"], perkPoints: 2 },
					{ label: "DMG +3", icons: ["swords"], perkPoints: 3 },
					{ label: "CP +1", icons: ["new_label"], perkPoints: 2 },
					{
						label: "Add (Roll 1) to you attack",
						icons: ["ifl", "swords"],
						perkPoints: 3,
					},
				],
				[
					{ label: "Momentum Lvl 3", icons: ["looks_3"], perkPoints: 3 },
					{ label: "HP +3", icons: ["heart_plus"], perkPoints: 3 },
					{
						label: "Sell and draw",
						icons: ["currency_exchange", "library_add"],
						perkPoints: 3,
					},
					{ label: "Momentum +2", icons: ["add_box"], perkPoints: 2 },
					{
						label: "Your attack is undefendable",
						icons: ["remove_moderator"],
						perkPoints: 4,
					},
				],
				[
					{ label: "Momentum Lvl 4", icons: ["looks_4"], perkPoints: 4 },
					{ label: "HP +4", icons: ["heart_plus"], perkPoints: 3 },
					{
						label: "Free recruit",
						icons: ["person_add"],
						perkPoints: 3,
					},
					{ label: "Draw", icons: ["library_add"], perkPoints: 2 },
					{
						label: "Reduce crisis clock advancement",
						icons: ["timer_arrow_down"],
						perkPoints: 3,
					},
				],
				[
					{ label: "Momentum Lvl 5", icons: ["looks_5"], perkPoints: 4 },
					{
						label: "Grant 2 Flight",
						icons: ["travel", "travel"],
						perkPoints: 3,
					},
					{
						label: "Grant 2 Shield",
						icons: ["health_and_safety", "health_and_safety"],
						perkPoints: 4,
					},
					{
						label: "CP +1, Draw",
						icons: ["new_label", "add_box"],
						perkPoints: 3,
					},
					{ label: "Free exhaust ability", icons: ["replay"], perkPoints: 4 },
				],
			];
			const perkData = perks.map((perkRow) => perkRow.map(() => 0));
			const DIFFICULTY_COUNT = perks.length;

			const missionCount = [2, 5, 5, 4, 4];
			const missionData = missionCount.flatMap((count, diffIndex) =>
				Array(count)
					.fill()
					.map((_, i) => ({
						name: `D${diffIndex + 1} - Mission ${i + 1}`,
						stage: 0,
						boss: 0,
						perfect: false,
						difficulty: diffIndex + 1,
					}))
			);

			// PERK MATH
			function getPerkPointsEarned() {
				return missionData.reduce((sum, m) => {
					let points = 0;
					if (m.perfect) points += 1;
					if (m.stage > 0) points += m.stage;
					if (m.boss > 0) points += m.boss;
					return sum + points;
				}, 0);
			}

			function getPerkPointsSpent() {
				return perkData.flat().reduce((a, b) => a + b, 0);
			}

			function updatePerkPointsDisplay() {
				const earned = getPerkPointsEarned();
				const spent = getPerkPointsSpent();
				document.getElementById(
					"perkPointsDisplay"
				).textContent = `${spent} / ${earned}`;
			}

			// PERK GRID
			function renderPerkGrid() {
				perkGrid.innerHTML = "";
				perks.forEach((perkRow, difficultyIndex) => {
					const section = createDiv("perk-section");
					const header = createDiv(
						"perk-header",
						`Difficulty ${difficultyIndex + 1}`
					);
					section.appendChild(header);

					perkRow.forEach((perkObj, perkIndex) => {
						// const row = createDiv("perk-entry");
						const row = createDiv(
							"perk-entry" + (perkIndex % 2 === 1 ? " alt" : "")
						);

						const icon = createDiv("perk-icon");
						perkObj.icons.forEach((iconName) => {
							const i = createDiv("material-symbols-outlined", iconName);
							icon.appendChild(i);
						});
						const label = createDiv("perk-label", perkObj.label);
						if (perkData[difficultyIndex][perkIndex] === perkObj.perkPoints) {
							icon.classList.add("active");
							label.classList.add("active");
						}
						const dots = createDiv("perk-dots", perkObj.dots);
						for (let i = 0; i < perkObj.perkPoints; i++) {
							const dot = createDiv("perk-dot");
							if (i < perkData[difficultyIndex][perkIndex]) {
								dot.classList.add("active");
							}
							dots.appendChild(dot);
						}

						row.onclick = () => {
							const current = perkData[difficultyIndex][perkIndex];
							const totalSpent = getPerkPointsSpent();
							const totalEarned = getPerkPointsEarned();

							if (current === perkObj.perkPoints || totalSpent >= totalEarned) {
								perkData[difficultyIndex][perkIndex] = 0;
							} else {
								perkData[difficultyIndex][perkIndex] = current + 1;
							}

							renderPerkGrid();
							updatePerkPointsDisplay();
						};

						row.appendChild(icon);
						row.appendChild(label);
						row.appendChild(dots);
						section.appendChild(row);
					});

					perkGrid.appendChild(section);
				});
			}

			// MISSION GRID
			function renderMissionGrid() {
				missionGrid.innerHTML = "";

				for (
					let difficulty = 1;
					difficulty <= missionCount.length;
					difficulty++
				) {
					const section = createDiv("mission-section");
					const header = createDiv(
						"mission-header",
						`Difficulty ${difficulty}`
					);
					section.appendChild(header);

					const missions = missionData.filter(
						(m) => m.difficulty === difficulty
					);
					missions.forEach((mission, index) => {
						const row = createDiv(
							"mission-entry" + (index % 2 === 1 ? " alt" : "")
						);

						const toggle = createDiv("mission-toggle");
						toggle.classList.toggle(
							"material-symbols-outlined",
							mission.perfect
						);
						toggle.classList.toggle("active", mission.perfect);
						toggle.textContent = mission.perfect ? "trophy" : "â–¢";
						toggle.onclick = () => {
							mission.perfect = !mission.perfect;
							renderMissionGrid();
							updatePerkPointsDisplay();
						};

						const label = createDiv("mission-label", mission.name);
						const countContainer = createDiv("mission-count");
						const stage = createDiv("count-button count-stage", mission.stage);
						stage.onclick = () => {
							mission.stage++;
							renderMissionGrid();
							updatePerkPointsDisplay();
						};
						const boss = createDiv("count-button count-boss", mission.boss);
						boss.onclick = () => {
							mission.boss++;
							renderMissionGrid();
							updatePerkPointsDisplay();
						};

						countContainer.appendChild(stage);
						countContainer.appendChild(boss);

						row.appendChild(toggle);
						row.appendChild(label);
						row.appendChild(countContainer);

						section.appendChild(row);
					});

					missionGrid.appendChild(section);
				}
			}

			function showTab(id) {
				document
					.querySelectorAll(".nav-button")
					.forEach((btn) => btn.classList.remove("active"));
				document
					.querySelectorAll(".tab-content")
					.forEach((tab) => tab.classList.remove("active"));

				// Activate the matching tab content
				document.getElementById(id).classList.add("active");

				// Activate the corresponding nav button
				// Match by data-tab attribute (safer than onclick string)
				document
					.querySelector(`.nav-button[data-tab="${id}"]`)
					?.classList.add("active");
			}

			try {
				renderPerkGrid();
				renderMissionGrid();
			} catch (e) {
				console.error("Render error:", e);
			}
		</script>

		<div class="bottom-bar">
			<input type="text" id="playerName" placeholder="Player Name" />
			<div id="perkPointsDisplay">0 / 0</div>
			<button id="saveButton">Save</button>
		</div>

		<div class="bottom-nav">
			<button
				data-tab="perkTab"
				class="nav-button active"
				onclick="showTab('perkTab')"
			>
				Perks
			</button>
			<button
				data-tab="missionTab"
				class="nav-button"
				onclick="showTab('missionTab')"
			>
				Missions
			</button>
		</div>
	</body>
</html>
